<link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">

<style>
.spacer20 {
  height: 20px;
}
</style>

<div class="sidebar">

  <div class="block">
    <b>Instruction</b>
    <p>1. Select the range of cells including data that you want to play.</p>
    <p>2. Click the "Play" button. you will hear the sound.</p>
  </div>
  
  <div class="block" id="button-bar">
    <button type="button" class="blue" id="soundActionButton" onclick="soundAction();" title="sound action">Play</button>
  </div>
  
  <div class="spacer20"></div>
  <hr>
  
  <div class="block">
    <b>Settings</b>
    <p>
      <input type="checkbox" id="loopCheckBox">
      <label for="loopCheckBox">Loop</label>
    </p>
  </div>
    
</div>

<script type="text/javascript">

    window.AudioContext = window.AudioContext || window.webkitAudioContext;

    var bufferSize = 4096;
    var numOutputs = 1; // mono
    var numInputs = 0;
    var context = new AudioContext();
    var node = undefined;
    var phase = 0;
    var dataSource = [];
    var dataLength = 0;
    var isLoop = false;
    
    function soundPlay(){
        isLoop = document.getElementById("loopCheckBox").checked;
        node = context.createScriptProcessor(bufferSize, numInputs, numOutputs);
        node.onaudioprocess = function(e) {
            var data = e.outputBuffer.getChannelData(0);
            var i = 0;
            var isEnd = false;
            while (i < bufferSize) {
                data[i] = dataSource[phase];
                i++;
                phase++;
                if (phase >= dataLength) {
                    if(isLoop) {
                        phase = 0;
                    } else {
                        isEnd = true;
                        break;
                    }
                }
            }
            if (isEnd) {
                document.getElementById("soundActionButton").innerText = "Play";
                soundStop();
            }
        }
        node.connect(context.destination);  
        document.getElementById("soundActionButton").disabled = false;
    }
    
    function soundStop(){
        phase = 0;
        dataSource = [];
        node.disconnect();
        node = undefined;
        document.getElementById("soundActionButton").disabled = false;
    }
    
    function soundAction() {
        document.getElementById("soundActionButton").disabled = true;
        if (node) {
            document.getElementById("soundActionButton").innerText = "Play";
            soundStop();
        } else {
            document.getElementById("soundActionButton").innerText = "Stop";
            soundDataLoad();
        }
    }
    
    function soundDataLoad() {
        google.script.run.withSuccessHandler(success).withFailureHandler(failure).getActiveCell();
    }
    
    function success(values) {
        dataSource = JSON.parse(values);
        dataLength = dataSource.length;
        if (dataLength > 0) {
            soundPlay();
        } else {
            document.getElementById("soundActionButton").disabled = false;
            document.getElementById("soundActionButton").innerText = "Play";
        }
    }
    
    function failure(error) {
        alert(error);
        document.getElementById("soundActionButton").disabled = false;
        document.getElementById("soundActionButton").innerText = "Play";
    }
    
</script>
