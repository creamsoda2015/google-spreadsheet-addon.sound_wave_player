<link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">

<div class="sidebar branding-below">
  <div class="block">
    <label for="translated-text"><b>Instruction</b></label>
    <p>1. Select the range of cells including data that you want to play.</p>
    <p>2. Click the "Play" button. you will hear the sound.</p>
  </div>
  <form id="addonForm">
    <div class="block" id="button-bar">
      <button type="button" class="blue" id="soundActionButton" onclick="soundAction();" title="sound action">Play</button>
    </div>
  </form>
</div>

<script type="text/javascript">

    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    var fs = 44100;
    var bufferSize = 4096;
    var numOutputs = 1; // mono
    var numInputs = 0;
    var context = new AudioContext();
    var node = undefined;
    var phase = 0;
    var loopDataSource = [];
    var loopData = [];
    
    function soundPlay(){
        node = context.createScriptProcessor(bufferSize, numInputs, numOutputs);
        node.onaudioprocess = function(e){
            var data = e.outputBuffer.getChannelData(0);
            // need for lower than bufferSize loopData
            while(loopData.length - phase < bufferSize){
                loopData = loopData.concat(loopDataSource);
            }
            var i = 0;
            while(i < bufferSize){
                data[i] = loopData[phase];
                i++;
                phase++;
            }
        }
        node.connect(context.destination);  
        document.getElementById("soundActionButton").disabled = false;
    }
    
    function soundStop(){
        phase = 0;
        loopData = [];
        node.disconnect();
        node = undefined;
        document.getElementById("soundActionButton").disabled = false;
    }
    
    function soundAction() {
        document.getElementById("soundActionButton").disabled = true;
        if(node){
            document.getElementById("soundActionButton").innerText = "Play";
            soundStop();
        } else {
            document.getElementById("soundActionButton").innerText = "Stop";
            soundDataLoad();
        }
    }
    
    function soundDataLoad() {
        google.script.run.withSuccessHandler(success).withFailureHandler(failure).getActiveCell();
    }
    
    function success(values) {
        loopDataSource = values;
        loopData = loopDataSource;
        soundPlay();
    }
    
    function failure(error) {
        alert(error);
        document.getElementById("soundActionButton").disabled = false;
        document.getElementById("soundActionButton").innerText = "Play";
    }
    
</script>
